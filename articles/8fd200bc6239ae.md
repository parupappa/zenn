---
title: "HarnessのIaCを調査する（Harness Git Experience）"
emoji: "🔬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["harness", "Terraform","CI/CD", "GitOps", "IaC"]
published: true
---
# はじめに

Harnessで複数のパイプライン構築しようとするときに、いちいちGUIでパイプラインを１から構築していくのはSRE的な観点からみるとトイルと言わざるを得ない

Harnessのネイティブ機能でパイプラインのclone（複製）はできるが、パラメータやクラスタの設定変更など全てプロビジョニングはできない

そこで、Harnessで構築するパイプライン自体をIaCで管理すべく、[Harness Git Experience](https://developer.harness.io/docs/category/git-experience)を中心に技術検証を行う

Harness Git Experienceの概要は[こちら](https://developer.harness.io/docs/platform/git-experience/git-experience-overview/)を参照

# 調査

[公式quickstart](https://developer.harness.io/docs/platform/Git-Experience/configure-git-experience-for-harness-entities)を元に[Harness Git Experience](https://developer.harness.io/docs/category/git-experience)で**実現出来ること・出来ないこと**の調査を行う

## Github

まずは、github上にリポジトリの作成を行い、Harnessパイプラインを構成するyamlファイルを管理

その後、PAT（Personal Access Token）を取得します。
PATに必要なアクセスは以下
```
- repo
- user
```


## Harness

### PAT（Personal Access Token）を取得
取得したPATを元に、対象リポジトリへのアクセス権を持つGithub Connector を作成します（パイプライン作成の途中でも作成可能）

### Remote Pipelinesを作成

※パイプラインを作成する前に、以下の設定をEnableにしないと、gitへyamlファイルが連携されないので、注意が必要

- `Allow different repo for Pipeline and InputSets`
- `Enforce git experience for pipelines and templates`

![スクリーンショット 2023-08-21 14.13.50.png](Harness%E3%81%AEIaC%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B%EF%BC%88Harness%20Git%20Experience%EF%BC%89%20b798e7da69b04d4fa93322f98d68e104/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588_2023-08-21_14.13.50.png)

パイプラインを作成

今回は技術検証のため、以下のようなシンプルなCDパイプラインを構築

- 手動でApproval → GKEクラスタにデプロイ
    - GKEクラスタへデプロイする設定などはこちらを参照
        - [HarnessでGKEクラスタにデプロイするまで](https://www.notion.so/Harness-GKE-776ef3a32430416eb29ad03e6be079c3?pvs=21)

![スクリーンショット 2023-08-21 15.28.00.png](Harness%E3%81%AEIaC%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B%EF%BC%88Harness%20Git%20Experience%EF%BC%89%20b798e7da69b04d4fa93322f98d68e104/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588_2023-08-21_15.28.00.png)

githubのorgの権限によっては、作成したPipelineを保存しようとすると以下になった。

（orgではOAuthのアクセスが許可されていなかったので、個人のリポジトリを指定したら解決）

![スクリーンショット 2023-08-18 16.26.54.png](Harness%E3%81%AEIaC%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B%EF%BC%88Harness%20Git%20Experience%EF%BC%89%20b798e7da69b04d4fa93322f98d68e104/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588_2023-08-18_16.26.54.png)

Saveすると、どのブランチへコミットするか聞かれるので、任意のブランチを選択

![スクリーンショット 2023-08-21 14.22.38.png](Harness%E3%81%AEIaC%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B%EF%BC%88Harness%20Git%20Experience%EF%BC%89%20b798e7da69b04d4fa93322f98d68e104/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588_2023-08-21_14.22.38.png)

gitリポジトリ上に以下のような`.harness`ディレクトリが作成される（ファイル名はPipeline作成時に指定可能）

このyamlファイルに構築したパイプラインが記述される

```
├── .harness
│   └── harnessgitexperience.yaml
└── README.md
```

パイプラインの変更をcommitし、PipelinesのGitOpsが実現するか確認

例：pipelineのnameを変更し、commit

```yaml
pipeline:
	name: harness-git-experience
```

Harness上で`Reload from Git`をし、パイプラインの更新を行う

ref: [https://developer.harness.io/docs/platform/Git-Experience/harness-git-cache](https://developer.harness.io/docs/platform/Git-Experience/harness-git-cache)

![スクリーンショット 2023-08-21 14.31.33.png](Harness%E3%81%AEIaC%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B%EF%BC%88Harness%20Git%20Experience%EF%BC%89%20b798e7da69b04d4fa93322f98d68e104/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588_2023-08-21_14.31.33.png)

パイプラインのnameが変更されたことを確認できればOK

# Harness Git Experience で出来ること

## HarnessリソースのGit管理

Harness Git Experience を使用して、次の Harness リソースを Git管理できる

- [Pipelines](https://developer.harness.io/docs/platform/Git-Experience/import-a-pipeline)
- [Input sets](https://developer.harness.io/docs/platform/git-experience/import-a-template-from-git/)
- [Templates](https://developer.harness.io/docs/platform/git-experience/import-a-template-from-git/)（EnterPrise版のみ）

また、Input setsとトリガーを指定したパイプラインの構築（Git管理）もできる

[https://developer.harness.io/docs/platform/Git-Experience/manage-input-sets-in-simplified-git-experience](https://developer.harness.io/docs/platform/Git-Experience/manage-input-sets-in-simplified-git-experience)

## インラインエンティティをGit管理に移管

Git管理されていない既存のパイプラインと入力セットをGit管理下に移管することができる

[https://developer.harness.io/docs/platform/Git-Experience/move-inline-entities-to-git](https://developer.harness.io/docs/platform/Git-Experience/move-inline-entities-to-git)

## OAuthとの統合

[https://developer.harness.io/docs/platform/Git-Experience/oauth-integration](https://developer.harness.io/docs/platform/Git-Experience/oauth-integration)

# Harness Git Experience で出来ないこと

## 対象外HarnessリソースのGit管理

PipelinesやTemplatesはgit管理可能だが、Organizationやプロバイダーとの疎通に必要やConnectorsなどの主要なリソースはGit管理することができない

パイプラインリソースのGitOpsとは異なる文脈だが、Terraformを使用すると、以下のリソースのプロビジョニングが可能である

```yaml
- Organizations
- Projects
- Delegates
- Connectors
- Secrets
- Variables
- Services
- Environments
- Infrastructure Definitions
- Pipelines
- Templates
- Permissions
```

[Harness Terraform Provider overview | Harness Developer Hub](https://developer.harness.io/docs/platform/Resource-Development/Terraform/harness-terraform-provider-overview)

つまり、Harnessリソース全体のIaCを実現したい場合には、Harness Git Experienceだけでは不十分。しかし、Terraformを使用する必要がある。

# 注意点

[Harness Git Ops](https://developer.harness.io/docs/category/gitops) ≠ [Harness Git Experience](https://developer.harness.io/docs/category/git-experience)

名前とパッと見の説明が似ているので注意

[Harness Git Ops](https://developer.harness.io/docs/category/gitops)

- Harnessでパイプラインを構築するクラスタ（アプリケーション）のGitOpsを実現
- ArgoCDのようなイメージ

[Harness Git Experience](https://developer.harness.io/docs/category/git-experience)

- Harnessで構築するパイプライン自体をGitOpsで実現する

# まとめ

Harness Git Experienceでは、HarnessリソースのすべてをIaCにすることは出来ない

また、Harnessリソースの構成管理やプロビジョニングをするという観点においては、Terraformを使用する必要がある。

あと、HarnessのYAMLを直接編集するのは、個人的にはすごくわかりづらいし、書きづらい。。。

# Reference

[Git Experience | Harness Developer Hub](https://developer.harness.io/docs/category/git-experience)