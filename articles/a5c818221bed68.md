---
title: "Harnessã§GKEã‚¯ãƒ©ã‚¹ã‚¿ã«CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰"
emoji: "ğŸš"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes", "GCP", "harness", "helm","CI/CD"]
published: true
---

# ã¯ã˜ã‚ã«

å®Ÿå‹™ã«ãŠã„ã¦[Harness](https://www.harness.io/)ã‚’ä½¿ç”¨ã™ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€ãŠè©¦ã—ãŒã¦ã‚‰GKEã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã«CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚

ï¼ˆâ€»ãªãŠã€ä»Šå›ã¯Harnessã®ä½¿ç”¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã‚‹ãŸã‚ã€CIã®å®Ÿè£…ã«ã¤ã„ã¦ã¯è€ƒæ…®ã—ã¦ãŠã‚Šã¾ã›ã‚“ï¼‰

ã€å¯¾è±¡ã€‘
- [Harness](https://www.harness.io/)ã«åˆã‚ã¦è§¦ã‚Œã‚‹æ–¹

### Harnessã¨ã¯ï¼Ÿ
- ä¸€è¨€ã§ã„ã†ã¨ã€**CI/CDãƒ„ãƒ¼ãƒ«**
    - https://harness.dxable.com/
- å¤šæ§˜ãªã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨é€£æºå¯èƒ½ãªç‚¹ãŒå€‹äººçš„ã«ã¯æœ€å¤§ã®é­…åŠ›ã ã¨æ€ã£ã¦ã„ã¾ã™ï¼




### ä½¿ç”¨ç’°å¢ƒ
ä»Šå›ã€å®Ÿè·µã™ã‚‹ç’°å¢ƒã¯ä»¥ä¸‹ã§ã™ã€‚

- Artifact Registory
    - [Github Container Registory](https://docs.github.com/ja/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
- ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
    - GKE
- ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
    - helm
- CD
    - Harness

### å‰æ

- GKEã‚¯ãƒ©ã‚¹ã‚¿ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- helmãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨

# æ‰‹é †

å¤§ã¾ã‹ãªæ‰‹é †ã¨ã‚„ã‚‹ã“ã¨ã¨ã—ã¦ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

1. `helm create` ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€github ãƒªãƒã‚¸ãƒˆãƒªã«push
2. Github Packegesã®Container Registoryã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’push
3. GKEã‚¯ãƒ©ã‚¹ã‚¿ãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«`ImagePullSecrets`ã‚’ä½œæˆã™ã‚‹
4. Harnessä¸Šã§CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
    
    Harnessã§ä½œæˆãŒå¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä»¥ä¸‹
    
    ```txt
    - Github Connector
    - GoogleCloud Connector
    - Harness Components
        - Service
        - Environment
    - Pipeline Trigger
    ```
    

# helm

`helm create` ã§ç°¡æ˜“çš„ãªãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ mkdir harness-sample-dir && cd harness-sample-dir
$ helm create harness-sample && cd harness-sample

$ tree
.
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ charts
â”œâ”€â”€ templates
â”‚Â Â  â”œâ”€â”€ NOTES.txt
â”‚Â Â  â”œâ”€â”€ _helpers.tpl
â”‚Â Â  â”œâ”€â”€ deployment.yaml
â”‚Â Â  â”œâ”€â”€ hpa.yaml
â”‚Â Â  â”œâ”€â”€ ingress.yaml
â”‚Â Â  â”œâ”€â”€ service.yaml
â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml
â”‚Â Â  â””â”€â”€ tests
â”‚Â Â      â””â”€â”€ test-connection.yaml
â””â”€â”€ values.yaml
```

ã“ã‚Œã«è¿½åŠ ã§ã€stgç’°å¢ƒç”¨ã¨prodç’°å¢ƒç”¨ã®2ã¤ã®valusãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ tree
.
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ templates
â”‚Â Â  â”œâ”€â”€ NOTES.txt
â”‚Â Â  â”œâ”€â”€ _helpers.tpl
â”‚Â Â  â”œâ”€â”€ deployment.yaml
â”‚Â Â  â”œâ”€â”€ hpa.yaml
â”‚Â Â  â”œâ”€â”€ ingress.yaml
â”‚Â Â  â”œâ”€â”€ service.yaml
â”‚Â Â  â””â”€â”€ serviceaccount.yaml
â”œâ”€â”€ values
â”‚Â Â  â”œâ”€â”€ prod.yaml
â”‚Â Â  â””â”€â”€ stg.yaml
â””â”€â”€ values.yaml
```

CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç¢ºèªãŒã§ãã‚Œã°è‰¯ã„ã®ã§ã€ä¸­èº«ã¯replicaæ•°ã®ã¿è¨˜è¿°ã—ãŸç°¡æ˜“çš„ãªã‚‚ã®ã«ã—ã¾ã™ã€‚

```yaml:values/stg.yaml
replicaCount: 1
```

```yaml:values/prod.yaml
replicaCount: 2
```

ä»Šå›ã¯Harnessã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã„ã¾ã™ãŒã€æ‰‹å‹•ã§ã‚¯ãƒ©ã‚¹ã‚¿ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
`NAMESPACES`ã¯è‡ªåˆ†ã§stgç’°å¢ƒç”¨ã®ã‚‚ã®ã¨ã€prodç’°å¢ƒç”¨ã®ã‚‚ã®ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# /harness-sample-dir
helm install harness-sample ./harness-sample -f ./harness-sample/values.yaml -n NAMESPACES
```

# Github Container Registory

æ¬¡ã«ã€[å…¬å¼doc](https://docs.github.com/ja/packages/working-with-a-github-packages-registry/working-with-the-container-registry#container-registry%E3%81%A7%E3%81%AE%E8%AA%8D%E8%A8%BC)ã‚’å‚ç…§ã—ã¦Github Container Registoryã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

### Dockerfile
dockerfileã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã‚’ç”¨æ„ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãŠãã¾ã™ã€‚
```dockerfile
FROM --platform=linux/amd64 nginx:1.25.1-alpine-slim
```

### èªè¨¼æ‰‹é †

[personal access token (classic)](https://docs.github.com/ja/packages/working-with-a-github-packages-registry/working-with-the-container-registry#personal-access-token-classic)ã§èªè¨¼ã‚’è¡Œã„ã¾ã™

ä½œæˆã™ã‚‹personal access token (classic)ã®æ¨©é™ã¯ä»¥ä¸‹ã‚’ä»˜ä¸

```text
- admin:repo_hook
- write:packages
- delete:packages
- repo
- user
```

èªè¨¼ãŒå®Œäº†ã—ã¦ã€`docker build`,  `docker push` ã‚’ã—ã€Github Container Registoryã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

# **ImagePullSecrets**ã®ä½œæˆ

[Kubernetesã§ private registry ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Pull ã™ã‚‹å ´åˆã«ã¯ ImagePullSecretsã‚’ä½¿ã†](https://medium.com/makotows-blog/kubernetes-private-registry-tips-image-pullsecretse-20dfb808dfc-e20dfb808dfc)å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§secretã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

**secretã¯namespaceã”ã¨ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

ï¼ˆGKEã‚¯ãƒ©ã‚¹ã‚¿ã‹ã‚‰ ghcr.io ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦ï¼‰

`GITHUB_USER_NAME`, `GITHUB_ACCESS_TOKEN`ã«githubã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚

ã¾ãŸã€`NAMESPACES`ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹namaspaceã‚’è¨­å®šã—ã¾ã™ã€‚

```bash
kubectl create secret docker-registry regcred --docker-server=https://ghcr.io --docker-username=GITHUB_USER_NAME --docker-password=GITHUB_ACCESS_TOKEN -n NAMESPACES
```

**â€»**`ImagePullSecrets`ã‚’è¨­å®šã—ãªã„ã¨ã€Pipelineå®Ÿè¡Œæ™‚ã«ã‚¤ãƒ¡ãƒ¼ã‚¸å–å¾—ã®ã‚¨ãƒ©ãƒ¼ï¼ˆ`ErrImagePull`ï¼‰ã«ãªã‚Šã¾ã™ã€‚

# Harness
Harnessã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚åŸºæœ¬çš„ã«ã¯ã€GUIä¸Šã§ãƒãƒãƒãƒã—ã¦ã„ãã ã‘ãªã®ã§ã™ãŒã€åˆã‚ã¦è§¦ã‚‹ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ¦‚å¿µãŒå°‘ã—ã‚„ã‚„ã“ã—ã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ã€[å…¬å¼doc](https://developer.harness.io/docs/getting-started/harness-first-gen-vs-harness-next-gen/#mapping-firstgen-to-nextgen-entities)ã«ç›®ã‚’é€šã—ã¦ã‹ã‚‰å®Ÿè·µã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

### Pipeline

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„æ‰¿èªãªã©ã®ãƒ•ãƒ­ãƒ¼ã«é–¢ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

ä»Šå›ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æµã‚Œã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```text
1. stg deploy æ‰¿èª
2. stg deploy
3. prod deploy æ‰¿èª
4. prod deploy
```

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-08-10 14.06.02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/669969/34b1569c-ee37-bf1e-87bf-8443c9c60475.png)


### Services

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹è¨­å®šã€‚

ã¾ãšã€ã‚µãƒ¼ãƒ“ã‚¹ãŒã©ã®ã‚ˆã†ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‹ï¼ˆä¾‹ãˆã°ã€Kubernetesã€Native Helmã€Serverlessãªã©ï¼‰ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¾ã™ã€‚

ãã®å¾Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹Artifactsã‚’è¨­å®šã—ã¾ã™ã€‚ï¼ˆä»Šå›ã¯ã€ã“ã“ã‚’Github Container Registoryã«æŒ‡å®šï¼‰

### Environments
ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãªã©ã®ç’°å¢ƒã«é–¢ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

ä»Šå›ã¯ã€å˜ä¸€GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä¸Šã«ã€`prod` ã¨ `stg` ã® namespace ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’åˆ¥ã®ç’°å¢ƒã«è¦‹ç«‹ã¦ã¦ Environments ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```bash
kubectl create ns stg
```

### Trigger

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒˆãƒªã‚¬ãƒ¼ã«é–¢ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã€‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç·¨é›†ç”»é¢ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚

ä»Šå›ã¯ã€æŒ‡å®šã®ãƒ–ãƒ©ãƒ³ãƒã¸pushã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚


### Google Cloud Connector

GoogleCloudã¨Harnessã‚’æ¥ç¶šã™ã‚‹ãŸã‚ã«ã€Connectorã‚’ä½œæˆã—ã¾ã™ã€‚

èªè¨¼æƒ…å ±ã«ã¯ã€[ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚­ãƒ¼ã®ä½œæˆã¨ç®¡ç†](https://cloud.google.com/iam/docs/creating-managing-service-account-keys?hl=ja#iam-service-account-keys-create-console)ã‚’å‚è€ƒã«ã€ä»Šå›ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

### å‹•ä½œç¢ºèª

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-08-10 14.13.33.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/669969/e3be7c61-73f1-54f9-9e46-bad50785399f.png)

GKEã‚’ç¢ºèªã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸnamespaceã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-08-10 14.15.11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/669969/510b4cea-07fe-95d8-2505-9170403f788c.png)

# ãƒãƒã‚Šãã†ãªãƒã‚¤ãƒ³ãƒˆ

- `Github Access Token`ã®æ¨©é™è¨­å®šã¯ã‚ˆãç¢ºèª
- `ImagePullSecrets`ã¯namespaceã”ã¨ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- Github Connector , GoogleCloud Connectorã®ç–é€šãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨


# å‚è€ƒ
https://github.com/harness/harness-cd-community
