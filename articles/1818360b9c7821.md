---
title: "é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹ Shared VPCï¼ˆå…±æœ‰VPCï¼‰ ~ GKE ã‚’Shared VPC ã§æ§‹ç¯‰ã™ã‚‹éš›ã®è‹¦æ‚©~"
emoji: "ğŸ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['gc24', 'GoogleCloud', 'GKE', 'terraform', 'VPC']
published: false
---

ã“ã®ãƒ–ãƒ­ã‚°ã¯ã€[ã€Google Cloudã€‘GDG Tokyo Monthly Online Tech Talks](https://gdg-tokyo.connpass.com/event/308519/)ã«ã¦ç™ºè¡¨ã—ãŸå†…å®¹ã‚’å…ƒã«ã—ã¦ã„ã¾ã™ã€‚

ç™»å£‡æ™‚ã®è³‡æ–™ã¯ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚

https://speakerdeck.com/parupappa2929/suan-imogan-imoarushared-vpc-gong-you-vpc-gkewoshared-vpcdegou-zhu-suruji-noku-nao


# ã¯ã˜ã‚ã«
[Google Cloud Shared VPCï¼ˆå…±æœ‰VPCï¼‰](https://cloud.google.com/vpc/docs/shared-vpc?hl=ja)ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã®é›†ä¸­ç®¡ç†ãŒã§ãã‚‹ä¸€æ–¹ã§ã€ãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨ã«é–¢ã—ã¦åˆ¶ç´„ãŒã‚ã£ãŸã‚Šã€ã‚¨ãƒ³ãƒ—ãƒ©ä¼æ¥­ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ã‚µã‚¤ãƒ­åŒ–ã•ã‚ŒãŸçµ„ç¹”ã§ã¯ã€å„ãƒãƒ¼ãƒ ã¨ã®ã‚³ãƒŸãƒ¥ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¹ãƒˆã‚„èª¿æ•´ã‚³ã‚¹ãƒˆãŒä¸ŠãŒã£ã¦ã—ã¾ã†ãƒªã‚½ãƒ¼ã‚¹ã§ã‚‚ã‚ã‚‹ã“ã¨ã‚’æ¡ˆä»¶ã‚’é€šã˜ã¦æ„Ÿã˜ã¾ã—ãŸã€‚

ãã‚“ãª**é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC**ä¸Šã«ã€GKEã‚’ä¸­å¿ƒã¨ã—ãŸä¸€èˆ¬çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ãŸéš›ã®è‹¦æ‚©ï¼ˆæ³¨æ„ç‚¹ï¼‰ã‚’ãŠä¼ãˆã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

Shared VPCã‚’æ¤œè¨ã—ã¦ã„ã‚‹äººã‚„ã€Shared VPCä¸Šã«GKEã‚’ã‚³ã‚¢ã¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã‚ˆã†ã¨ã™ã‚‹äººã«å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# Shared VPCï¼ˆå…±æœ‰VPCï¼‰ã¨ã¯ï¼Ÿ

Google Cloudã®Shared VPCã‚’æ‰€æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’**ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã€Shared VPCã‚’åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’**ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã¨å‘¼ã³ã¾ã™ã€‚

Shared VPCã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã®å…±æœ‰ãŒå¯èƒ½ã¨ãªã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã®é›†ä¸­ç®¡ç†ãŒå®Ÿç¾ã—ã¾ã™ã€‚

![alt text](<../images/é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC_1818360b9c7821/shared_vpc.png>)

https://cloud.google.com/vpc/docs/shared-vpc?hl=ja

### Shared VPCã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

Shared VPCã¯ã€ç‰¹ã«å¤§è¦æ¨¡ãªçµ„ç¹”ï¼ˆã‚¨ãƒ³ãƒ—ãƒ©çµ„ç¹”ï¼‰ã‚„è¤‡æ•°ã®ãƒãƒ¼ãƒ ãŒé–¢ä¸ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãã®ä¾¡å€¤ã‚’ç™ºæ®ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€è¤‡æ•°ã®é–‹ç™ºãƒãƒ¼ãƒ ãŒç•°ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‹…å½“ã—ã¦ã„ã‚‹ãŒã€å…¨ã¦ã®ãƒãƒ¼ãƒ ãŒå…±é€šã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ï¼ˆã‚µãƒ–ãƒãƒƒãƒˆã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ãªã©ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãªã©ã§ã™ã€‚

IAMãƒ­ãƒ¼ãƒ«ã¨ã—ã¦ã‚‚[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ ï¼‰ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†è€…ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ï¼‰ãŒã‚ã‚‹](https://cloud.google.com/vpc/docs/shared-vpc?hl=ja#net_and_security_admins)ã“ã¨ã‹ã‚‰é‹ç”¨ã¯ã€å„ãƒãƒ¼ãƒ ã‚„æ‹…å½“è€…ãŒè‡ªåˆ†ãŸã¡ã®æ‹…å½“é ˜åŸŸã‚’ç‹¬è‡ªã®é‹ç”¨ã§å›ã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚ï¼ˆã‚‚ã¡ã‚ã‚“ä¾‹å¤–ã¯ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒï¼‰

# å‰æï¼šã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

- ä¸€èˆ¬çš„ãªAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãªã‚‹æ§‹æˆ
    - GKE Autopilotï¼ˆv1.27ï¼‰
        - ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚ŒãŸ[é™å®šå…¬é–‹ã‚¯ãƒ©ã‚¹ã‚¿](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters)
- ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯terraformã«ã‚ˆã‚‹æ§‹æˆç®¡ç†


![alt text](<../images/é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC_1818360b9c7821/architecture.png>)

![alt text](<../images/é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC_1818360b9c7821/shared_vpc_terraform.png>)

ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ï¼ˆ0ã‹ã‚‰æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒãªã‹ãªã‹ãªã„ãŸã‚ï¼‰ã™ã§ã«ä½œæˆã•ã‚Œã¦ãŠã‚Šã€æ–°ã—ãã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã€GKEã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ ãŒ[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…](https://cloud.google.com/vpc/docs/shared-vpc?hl=ja#net_and_security_admins)ã¨ã—ã¦å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¦æ–°è¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚

ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ä½œæˆã™ã‚‹éš›ã®äº‹ä¾‹ã¯ä»¥ä¸‹ãŒå‚è€ƒã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

[https://techblog.zozo.com/entry/gcp-shared-vpc](https://techblog.zozo.com/entry/gcp-shared-vpc)

# GKEã‚’Shared VPCç’°å¢ƒã§æ§‹ç¯‰ã™ã‚‹éš›ã®æŠ€è¡“çš„å¥®é—˜

## ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¥ç¶š

ä¸‹è¨˜ã®é€šã‚Šã€Shared VPCã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€å ´åˆã«ã‚ˆã£ã¦ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…ã«ä¾é ¼ãŒå¿…è¦ã§ã—ã‚‡ã†ã€‚

> ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç®¡ç†è€…ãŒå…±æœ‰ VPC ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ›ã‚¹ãƒˆ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> 

[https://cloud.google.com/vpc/docs/provisioning-shared-vpc?hl=ja#create-shared](https://cloud.google.com/vpc/docs/provisioning-shared-vpc?hl=ja#create-shared)

## **Terraformå®Ÿè¡Œã®ãŸã‚ã®ã€Google Cloud ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™å€Ÿç”¨**

[Infrastructure-as-Code ã‚’æœ€å°æ¨©é™ã§å®Ÿè¡Œã™ã‚‹](https://cloud.google.com/blog/ja/products/devops-sre/running-infrastructure-code-least-privilege-possible)ã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€IAM ä½¿ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¾¹åº•ã™ã‚‹ãŸã‚ã«ã€Terraform ã®ã‚³ãƒ¼ãƒ‰ã¯[æœ€å°æ¨©é™ã®åŸå‰‡](https://cloud.google.com/iam/docs/using-iam-securely#least_privilege)ã«æ²¿ã£ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ Terraform ã‚³ãƒ¼ãƒ‰ã§åˆ¶é™ã™ã‚‹ä»£ã‚ã‚Šã«ã€[ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ](https://cloud.google.com/iam/docs/understanding-service-accounts)ã‚’ä½¿ç”¨ã—ã¦ Terraform ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[https://cloud.google.com/blog/ja/topics/developers-practitioners/using-google-cloud-service-account-impersonation-your-terraform-code](https://cloud.google.com/blog/ja/topics/developers-practitioners/using-google-cloud-service-account-impersonation-your-terraform-code)

ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹èªè¨¼ã¯ã€ä»¥ä¸‹ï¼’ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™

- [ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚­ãƒ¼](https://cloud.google.com/iam/docs/creating-managing-service-account-keys)ã‚’ç”Ÿæˆ
    - ãŸã ã—ã€ã“ã®æ–¹æ³•ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ã‚­ãƒ¼ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦èªè¨¼ã‚’å—ã‘ã‚Œã‚‹ã¨ã„ã†ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€å®šæœŸçš„ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚­ãƒ¼ã‚’ç®¡ç†ã—ã€API ã‚­ãƒ¼ã®åˆ¶é™ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- [ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™å€Ÿç”¨](https://cloud.google.com/iam/docs/impersonating-service-accounts)
    - ã“ã®æ–¹æ³•ã®å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚­ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ä¸è¦ã§ã€ä»£ã‚ã‚Šã« IAM æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½¿ç”¨ã‚’æ‰¿èªã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ã ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¸ãˆã‚‹æ¨©é™ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸã‚‰ã€Google Cloud IAM ã§ã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’å‰Šé™¤ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚
    - AWSã§ã¯`AssumeRole`ã®ã‚¤ãƒ¡ãƒ¼ã‚¸


https://blog.g-gen.co.jp/entry/using-google-cloud-service-account-impersonation](https://blog.g-gen.co.jp/entry/using-google-cloud-service-account-impersonation

Shared VPCã®ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®æ¨©é™ã‚’æŒã¤SAã‚’ç™ºè¡Œã—ã¦ã€ãã®SAã®æ¨©é™ã‚’ä½¿ã£ã¦Terraformã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã®å‚ç…§ã‚’è¡Œã„ã¾ã™ã€‚

[https://cloud.google.com/blog/ja/topics/developers-practitioners/using-google-cloud-service-account-impersonation-your-terraform-code](https://cloud.google.com/blog/ja/topics/developers-practitioners/using-google-cloud-service-account-impersonation-your-terraform-code)

ä¸Šè¨˜è¨˜äº‹ã®æ–¹æ³•ã§terraform providerã«SAã®æƒ…å ±ã‚’ç´ã¥ã‘ã€SharedVPCé–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ãƒ»ä½œæˆã™ã‚‹å ´åˆã«providerã‚’æŒ‡å®šã—ã¦ä½¿ç”¨ã™ã‚‹ã€‚

```**hcl**
provider "google" {
  project = "YOUR_PROJECT_ID"
  alias   = "impersonation"
  scopes  = [
    "https://www.googleapis.com/auth/cloud-platform",
    "https://www.googleapis.com/auth/userinfo.email",
  ]
}

# Networkç®¡ç†è€…ã«æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã—ã¦ã‚‚ã‚‰ã†ãŸã‚ã€Service Accountã¯æ‰‹å‹•ã§ä½œæˆã—ã€dataã§å–å¾—
data "google_service_account" "default" {
  account_id = "YOUR_SERVICE_ACCOUNT@YOUR_PROJECT.iam.gserviceaccount.com"
}

data "google_service_account_access_token" "default" {
  target_service_account = data.google_service_account.default.email
  scopes                 = ["userinfo-email", "cloud-platform"] 
  lifetime               = "3600s"
}

provier "google" {
  project         = "YOUR_PROJECT_ID"
ã€€access_token    = data.google_service_account_access_token.default.access_token
  request_timeout = 60s
}
```

### ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ¨©é™ä»˜ä¸

å„ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® GKE ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Â [Host ã‚µãƒ¼ãƒ“ã‚¹ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼](https://cloud.google.com/kubernetes-engine/docs/how-to/iam?hl=ja#host_service_agent_user)ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® GKE ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® GKE ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨åŒæ§˜ã«ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

ã“ã®ãƒ­ãƒ¼ãƒ«ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® GKE ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã®ã¿ä»˜ä¸ã§ãã¾ã™ã€‚

GKE ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å½¢å¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```
service-SERVICE_PROJECT_NUM@container-engine-robot.iam.gserviceaccount.com

â€»**SERVICE_PROJECT_NUM**Â ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·ã§ã™ã€‚
```

[https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#grant_host_service_agent_role](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#grant_host_service_agent_role)

Shared VPCä¸Šã§GKEã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹æˆã™ã‚‹å ´åˆã«ã¯ã€ã¾ãšã“ã®è¨˜äº‹ã‚’è¦‹ã‚‹ã“ã¨ã‚’**å¼·ã**ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ï¼

[https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#overview](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#overview)

### ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ¨©é™ä»˜ä¸

Terraform å®Ÿè¡Œè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€`ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆè€…`ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚

ã“ã‚Œã¯ã€`terraform plan`å®Ÿè¡Œæ™‚ã«ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã—ã¦ã®èªè¨¼ã§ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã§ã™ã€‚

ã¾ãŸã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®GKEã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€**[Hostã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼](https://cloud.google.com/kubernetes-engine/docs/how-to/iam?hl=ja#host_service_agent_user)**ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

GKEã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å½¢å¼ã¯ä»¥ä¸‹

```jsx
service-SERVICE_PROJECT_NUM@container-engine-robot.iam.gserviceaccount.com
```

[https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#grant_host_service_agent_role](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#grant_host_service_agent_role)

## GKEã«å¿…è¦ãªã‚µãƒ–ãƒãƒƒãƒˆã‚’æ‰•ã„å‡ºã™

Shared VPCã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€GKEã«å¿…è¦ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯Shared VPã®ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã•ã‚ŒãŸã‚‚ã®ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

![alt text](<../images/é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC_1818360b9c7821/ip_address_management_in_GKE.jpg>)


[https://cloud.google.com/blog/ja/products/containers-kubernetes/ip-address-management-in-gke](https://cloud.google.com/blog/ja/products/containers-kubernetes/ip-address-management-in-gke)

ãã‚Œãã‚Œã«å¯¾ã—ã¦å¿…è¦ã¨ã•ã‚Œã‚‹CIDRã‚’è¨­è¨ˆã—ã¾ã™ã€‚

- Node
- Pod
- Service

GKEã‚¯ãƒ©ã‚¹ã‚¿ã¸ã®å‰²ã‚Šå½“ã¦ã‚‹CIDRè¨­è¨ˆã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

[https://future-architect.github.io/articles/20191017/](https://future-architect.github.io/articles/20191017/)

ã¾ãŸã€[Autopilotï¼ˆGKE: v1.27ã¾ã§ã¯ï¼‰ã§ã¯ã€Nodeã‚ãŸã‚Šã®Podæ•°ã®ä¸Šé™ãŒ32ã¨ãªã£ã¦ã„ã‚‹](https://cloud.google.com/kubernetes-engine/docs/how-to/flexible-pod-cidr?hl=ja#cidr_settings_for_clusters)ãŸã‚ã€Standardãƒ¢ãƒ¼ãƒ‰ã‚ˆã‚Šã‚‚åºƒã„CIDRãŒå¿…è¦ã¨ãªã‚‹ã®ã§è¨­è¨ˆã«æ³¨æ„


### **ä¸é€£ç¶šã®ãƒãƒ«ãƒ Pod CIDR**

Secondaryã®IPãŒè¶³ã‚‰ãªã‘ã‚Œã°ã€**ä¸é€£ç¶šãƒãƒ«ãƒ Pod CIDR**ã‚’ä½¿ã„ã€Nodeãƒ¬ãƒ™ãƒ«ã§å¿…è¦ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‹¡å¼µã™ã‚‹ã¨ã„ã†æ‰‹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚

![alt text](<../images/é…¸ã„ã‚‚ç”˜ã„ã‚‚ã‚ã‚‹Shared VPC_1818360b9c7821/multipod.png>)

[https://cloud.google.com/kubernetes-engine/docs/how-to/multi-pod-cidr?hl=ja#how_discontiguous_multi-pod_cidr_works](https://cloud.google.com/kubernetes-engine/docs/how-to/multi-pod-cidr?hl=ja#how_discontiguous_multi-pod_cidr_works)

ã¡ãªã¿ã«ã€Serviceãƒ¬ãƒ™ãƒ«ã®CIDRæ‹¡å¼µã¯Kubernetes 1.29 ã§ã‚¢ãƒ«ãƒ•ã‚¡æ©Ÿèƒ½ã¨ã—ã¦æ­è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

[https://qiita.com/uesyn/items/7768c2adb426e6ad2864#apis-to-manage-ip-address-ranges-for-services-sig-network-ip-address-range-apis](https://qiita.com/uesyn/items/7768c2adb426e6ad2864#apis-to-manage-ip-address-ranges-for-services-sig-network-ip-address-range-apis)

---

## VPC Service Controlsã®è¨­å®š

ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒã˜å¢ƒç•Œã«ã„ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®ä½œæ¥­ã«ãªã‚‹ãŸã‚ã€ã“ã¡ã‚‰ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…ã«ä¾é ¼ãŒå¿…è¦ã§ã™ã€‚

> å…±æœ‰ VPC ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å…±æœ‰ VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å±ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã‚€ã‚µãƒ¼ãƒ“ã‚¹å¢ƒç•Œã«ã¯ã€ãã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚å«ã¾ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…±æœ‰ VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å±ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ›ã‚¹ãƒˆ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨åŒã˜å¢ƒç•Œã«ãªã„å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ã¯æœŸå¾…ã©ãŠã‚Šã«å‹•ä½œã—ãªã„ã‹ã€å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
> 
> 
> å…±æœ‰ VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ›ã‚¹ãƒˆãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨åŒã˜ã‚µãƒ¼ãƒ“ã‚¹å¢ƒç•Œã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
> 

[https://cloud.google.com/vpc-service-controls/docs/troubleshooting?hl=ja#shared_vpc](https://cloud.google.com/vpc-service-controls/docs/troubleshooting?hl=ja#shared_vpc)

VPC Service ControlsãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹APIæ“ä½œã®åˆ¶é™ãŒã‹ã‹ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆçµ„ç¹”ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹ï¼‰

ä¾‹ãˆã°ã€terraformã‚’ã¯ã˜ã‚ã¨ã™ã‚‹å¤–éƒ¨APIã‹ã‚‰ã®æ“ä½œãŒã§ããªã„ãªã©ã€ã‚»ã‚­ãƒ¥ã‚¢ã«ã™ã‚‹å–ã‚Šçµ„ã¿ã‚’æ–½ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

VPC Service Controleã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ç¢ºèªã—ã¦Cloud Loggingã«ãƒ­ã‚°ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã©ã“ã¾ã§åˆ¶é™ãŒã‹ã‹ã£ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

[https://cloud.google.com/vpc-service-controls/docs/concepts](https://cloud.google.com/vpc-service-controls/docs/concepts)

[https://cloud.google.com/vpc-service-controls/docs/troubleshooting?hl=ja](https://cloud.google.com/vpc-service-controls/docs/troubleshooting?hl=ja)

## ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Firewall Ruleã‚’è¨­å®šã—ãªã„ã¨GKE Nodeã«å¯¾ã™ã‚‹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒé€šã‚‰ãªã„

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆFirewallãƒ«ãƒ¼ãƒ«ã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ‰€å±ã™ã‚‹GKEãƒãƒ¼ãƒ‰ã¸ã®Firewallãƒ«ãƒ¼ãƒ«ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Firewallãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ï¼ˆã“ã¡ã‚‰ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…ã¸ã®ä¾é ¼ãŒå¿…è¦ã§ã™ï¼‰

ã¾ãŸã¯ã€é©åˆ‡ãªIAMãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®GKE ã‚¯ãƒ©ã‚¹ã‚¿ã§ã€ãƒ›ã‚¹ãƒˆ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ç®¡ç†ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

[https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#managing_firewall_resources](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=ja#managing_firewall_resources)

## é™å®šå…¬é–‹ã‚¯ãƒ©ã‚¹ã‚¿ã®Podã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã«ã¯ã€ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«Cloud NatãŒå¿…è¦

Nodeã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Cloud Natã®ãƒãƒƒãƒ”ãƒ³ã‚°ã«å«ã‚ã‚‹å¿…è¦ã‚ã‚Šã¾ã™ã€‚

[https://cloud.google.com/nat/docs/nat-product-interactions?hl=ja#interaction-shared-vpc](https://cloud.google.com/nat/docs/nat-product-interactions?hl=ja#interaction-shared-vpc)

ä¾‹ãˆã°ã€Docker Hubãªã©å¤–éƒ¨ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«Cloud NATã®å¯¾è±¡ã‚µãƒ–ãƒãƒƒãƒˆã«ãƒãƒ¼ãƒ‰ã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆã“ã¡ã‚‰ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†è€…ã¸ã®ä¾é ¼ãŒå¿…è¦ã§ã™ï¼‰

## Shared VPCã®ä¸€èˆ¬çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã¸ã®åˆ¶ç´„

### Memorystore for Redis

Shared VPCã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã®ã€Memorystore for Redisã®æ¥ç¶šæ–¹æ³•ã¯ã€Private Service Accessã®ã¿ã«ãªã‚Šã¾ã™ã€‚

[https://cloud.google.com/memorystore/docs/redis/networking?hl=ja#choosing_a_connection_mode](https://cloud.google.com/memorystore/docs/redis/networking?hl=ja#choosing_a_connection_mode)

```yaml
resource "google_redis_instance" "memorystore_redis" {
  name               = "${var.prefix}-${var.service}-redis-instance-${var.env}"
  region             = var.region
  tier               = "STANDARD_HA"
  connect_mode       = "PRIVATE_SERVICE_ACCESS"
  authorized_network = "${var.your-shared-vpc}"
  redis_version      = "REDIS_7_0"
  read_replicas_mode = "READ_REPLICAS_ENABLED"
  replica_count      = var.redis_replicas

  reserved_ip_range  = "${var.private-service-access-subnet}"
  secondary_ip_range = "${var.private-service-access-subnet}"
  memory_size_gb     = 5
}
```

Private Service Accessç”¨ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºä¿ã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆCIDRç¯„å›²ã¯/24~/29ï¼‰

[https://cloud.google.com/memorystore/docs/redis/establish-connection?hl=ja](https://cloud.google.com/memorystore/docs/redis/establish-connection?hl=ja)

[https://cloud.google.com/vpc/docs/private-services-access?hl=ja#example](https://cloud.google.com/vpc/docs/private-services-access?hl=ja#example)

# ã¾ã¨ã‚

Shared VPCã§GKEã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã¯ã€ã•ã¾ã–ã¾ãªè€ƒæ…®ã™ã¹ãäº‹é …~~ï¼ˆè‹¦æ‚©ï¼‰~~ãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã®ä¸€å…ƒç®¡ç†ã‚„ã‚µã‚¤ãƒ­åŒ–ã•ã‚ŒãŸçµ„ç¹”ã§ã®é‹ç”¨ã«ã¯åˆè‡´ã—ã¦ã„ã‚‹ç‚¹ã‚‚ã‚ã‚Šã¾ã™ãŒã€æ§‹ç¯‰ãŠã‘ã‚‹ä¸€å®šã®å¥®é—˜ã‚‚å¿…è¦ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚’ç†è§£ã—ãŸä¸Šã§ã€å–ã‚Šçµ„ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# å‚è€ƒ

- **[GCPã®æ–°ãŸãªåœ°å¹³ç·šï¼šå…±æœ‰VPCã®å…¨è²Œ (2023.JUNE.7th, with ChatGPT-4)](https://note.com/noise_net/n/n5a03db3e34df)**
- [GCP Shared VPCã‚’åˆ©ç”¨ã—ãŸå…¨ç¤¾å…±é€šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é‹ç”¨ã«ãŠã‘ã‚‹Dedicated Interconnectåˆ©ç”¨è¨­å®šã®æœ€é©åŒ–æ‰‹æ³•](https://techblog.zozo.com/entry/gcp-shared-vpc)